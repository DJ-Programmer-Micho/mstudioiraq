<!doctype>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Add Artist | M Studio Iraq</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- Style -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/Mstyle.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-lg d-flex justify-content-between b3 m-3">
        <a class="navbar-brand my-auto" href="#">
            <img src="https://i.ibb.co/f036Rm7/MET-Logo.jpg" width="65px"></a>
        <h3 id="who" class="text-white">
            </h1>
            <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="btn btn-outline-secondary nav-link" onclick="out()">Sign Out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-5">

        <div class="row mt-3">
            <div class="col-6 mt-1">
                <h3 class="text-left">Artist Name</h3>
                <input type="text" id="artistName" name="artistName" class="form-control" placeholder="Artist Name">
            </div>
            <div class="col-md-6 mb-2">
                <h5>Album Artist</h5>
                <img id="myimg" class="img-fluid" src="../images/icons/uploadimg.png" width="200" height="200"><br>
                <button id="select" name="select" class="btn btn-outline-primary">Select first Image</button>
                <input id="imgname" name="imgname" type="hidden" placeholder=":عنوان الصورة" autocomplete="off"
                    required>
            </div>
            <div class="progress form-group">
                <div id="upP" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-6 mt-1">
                <h3 class="text-left">Card Link</h3>
                <input type="text" id="cardLink" name="cardLink" class="form-control" placeholder="Card Link" value="mylink.mstudioiraq.com/">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-6 mt-1">
                <h3 class="text-left">Amazon Music</h3>
                <input type="text" id="amazon" name="amazon" class="form-control" placeholder="Amazon Music">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Anghami</h3>
                <input type="text" id="anghami" name="anghami" class="form-control" placeholder="Anghami">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Apple Music</h3>
                <input type="text" id="apple" name="apple" class="form-control" placeholder="Apple Music">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Deezer</h3>
                <input type="text" id="deezer" name="deezer" class="form-control" placeholder="Deezer">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Instagram</h3>
                <input type="text" id="instagram" name="instagram" class="form-control" placeholder="Instagram">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Snapchat</h3>
                <input type="text" id="snapchat" name="snapchat" class="form-control" placeholder="Snapchat">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Soundcloud</h3>
                <input type="text" id="soundCloud" name="soundCloud" class="form-control" placeholder="Soundcloud">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Spotify</h3>
                <input type="text" id="spotify" name="spotify" class="form-control" placeholder="Spotify">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">TikTok</h3>
                <input type="text" id="tiktok" name="tiktok" class="form-control" placeholder="TikTok">
            </div>
            <div class="col-6 mt-1">
                <h3 class="text-left">Youtube</h3>
                <input type="text" id="youtube" name="youtube" class="form-control" placeholder="Youtube">
            </div>
        </div>

        <input type="hidden" id="countD" required>
        <input type="hidden" id="publisher" required>   

        <div class="form-group mt-5">
            <button id="upload" name="uplo" class="btn btn-primary btn-block">Send</button>
            <hr>
            <div class="progress form-group">
                <div id="upP" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">
                </div>
            </div>
            <hr>
            <a href="../control/admin/dash.html" class="btn btn-danger btn-block">Cancel</a>
        </div>

    </div>


    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
    <script src="../db/db.js"></script>
    <script>
        const auth = firebase.auth();
    </script>


    <script>
        /*
    user
    */

        auth.onAuthStateChanged(user => {
            if (user) {

            const who = document.querySelector('#who');
                var pub = user.uid;
                db.collection('user').where("uid", "==", pub).get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        var publisherName = doc.data().publisher;
                        who.innerHTML = "Welcome " + publisherName;
                        document.querySelector('#publisher').value = publisherName;
                    })
                })


                window.onload = function () {
                    var input = document.getElementById("artistName").focus();
                }



                var ImgName, ImgUrl;
                var files = [];
                var reader;
                const ref = db.collection("artist");
                // var refc = db.doc("count/upload");
                var refd = db.doc("countD/no");

                const upload = document.querySelector("#upload");
                // const count = document.querySelector("#imgname");


                //Taking Number
                refd.get().then((doc) => {
                    if (doc && doc.exists) {
                        const output1 = doc.data();
                        var countdesc = output1.no - 1;

                        refd.update({
                            no: countdesc
                        }).then(function () {
                            document.querySelector('input[id = "imgname"]').value = countdesc;
                            document.querySelector('#countD').value = countdesc;
                        }).catch(function (error) {
                            console.log("Nope, ", error);
                        });
                    }
                });

                //Adding Image
                document.getElementById("select").onclick = function (e) {

                    var input = document.createElement('input');
                    input.type = 'file';

                    input.onchange = e => {
                        files = e.target.files;
                        reader = new FileReader();
                        reader.onload = function () {
                            document.getElementById("myimg").src = reader.result;
                        }
                        reader.readAsDataURL(files[0]);
                    }
                    input.click();
                }


                upload.addEventListener("click", function () {

                    artistName = document.getElementById('artistName').value;
                    cardLink = document.getElementById('cardLink').value;
                    amazon = document.getElementById('amazon').value;
                    anghami = document.getElementById('anghami').value;
                    apple = document.getElementById('apple').value;
                    deezer = document.getElementById('deezer').value;
                    instagram = document.getElementById('instagram').value;
                    snapchat = document.getElementById('snapchat').value;
                    soundCloud = document.getElementById('soundCloud').value;
                    spotify = document.getElementById('spotify').value;
                    tiktok = document.getElementById('tiktok').value;
                    youtube = document.getElementById('youtube').value;
                    seq = document.getElementById('countD').value;
                    publisher = document.getElementById('publisher').value;
                    console.log("sending");

                    ImgName = document.getElementById('imgname').value;

                    console.log(files[0]);
                    var uploadTask = firebase.storage().ref('artist_album_art/' + ImgName + ".png").put(
                        files[0]);

                    console.log('artist_album_art/' + ImgName + ".png");
                    uploadTask.on('state_changed', function (snapshot) {
                            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('upP').style.width = progress + '%';
                            console.log(progress + '%');
                        },
                        //err
                        function (error) {
                            alert('Something went Wrong!');
                        },
                        //submit          
                        function () {
                            uploadTask.snapshot.ref.getDownloadURL().then(function (url) {
                                ImgUrl = url;




                                var data = {
                                    label: artistName,
                                    card_link: cardLink+artistName,
                                    amazon: amazon,
                                    anghami: anghami,
                                    apple: apple,
                                    deezer: deezer,
                                    instagram: instagram,
                                    snapchat: snapchat,
                                    soundCloud: soundCloud,
                                    spotify: spotify,
                                    tiktok: tiktok,
                                    youtube: youtube,
                                    timestamp: firebase.firestore.FieldValue
                                        .serverTimestamp(),
                                    publisher: publisher,
                                    no: seq,
                                    active: "1",
                                    image: ImgUrl
                                }


                                ref.doc(artistName).set(data, {
                                    merge: true
                                }).then(function () {
                                    window.alert(
                                        "Data has been Uploaded Succefully");
                                    setTimeout(() => {
                                        window.location.href =
                                            '../control/admin/dash.html';
                                    }, 2000);
                                }).catch(function (error) {
                                    window.alert(error, "Something went wrong!");
                                });
                            })
                        });
                });
                /*
                end of user 
                */
            } else {
                window.alert("No Active User");
            }
        });
    </script>
</body>

</html>